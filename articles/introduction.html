<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="zeitzeiger">
<title>Introduction to ZeitZeiger • zeitzeiger</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to ZeitZeiger">
<meta property="og:description" content="zeitzeiger">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">zeitzeiger</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.1.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/introduction.html">Introduction to ZeitZeiger</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://www.hugheylab.org/software/" target="_blank" aria-label="Hughey Lab">Hughey Lab</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/hugheylab/zeitzeiger/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Introduction to ZeitZeiger</h1>
            
            <h4 data-toc-skip class="date">2022-11-30</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/hugheylab/zeitzeiger/blob/HEAD/vignettes/introduction.Rmd" class="external-link"><code>vignettes/introduction.Rmd</code></a></small>
      <div class="d-none name"><code>introduction.Rmd</code></div>
    </div>

    
    
<p>ZeitZeiger is a method for supervised learning on high-dimensional
data from an oscillatory system. This vignette goes through an example
of how to use ZeitZeiger to train and test a predictor, perform
cross-validation, and plot the results.</p>
<div class="section level2">
<h2 id="load-the-necessary-packages">Load the necessary packages<a class="anchor" aria-label="anchor" href="#load-the-necessary-packages"></a>
</h2>
<p>First let’s load the necessary packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://r-datatable.com" class="external-link">'data.table'</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org" class="external-link">'ggplot2'</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://zeitzeiger.hugheylab.org">'zeitzeiger'</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">doParallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span>cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># register a parallel backend to minimize runtime</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="generate-example-data">Generate example data<a class="anchor" aria-label="anchor" href="#generate-example-data"></a>
</h2>
<p>Now we’ll simulate data from an oscillatory system. Our simulated
data will have 100 observations, with measurements of 200 features and
10 time-points per period. Each feature will have Gaussian noise. We’ll
call the periodic variable here “time,” which will go between 0 and
1.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nObs</span> <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="va">nFeatures</span> <span class="op">=</span> <span class="fl">200</span></span>
<span><span class="va">amp</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span></span>
<span><span class="va">time</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span>, length.out <span class="op">=</span> <span class="va">nObs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">nObs</span> <span class="op">*</span> <span class="va">nFeatures</span>, sd <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">nObs</span><span class="op">)</span></span></code></pre></div>
<p>The oscillator will produce three patterns: a sine, a cosine, and a
cosine with twice the frequency. For each of the three patterns, two
features will have relatively strong signal and eight more will have
relatively weak signal.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">baseSignal</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="va">time</span> <span class="op">*</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">3</span> <span class="op">*</span> <span class="va">baseSignal</span></span>
<span><span class="va">x</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">baseSignal</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">ii</span> <span class="kw">in</span> <span class="fl">3</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span><span class="op">[</span>, <span class="va">ii</span><span class="op">]</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span>, <span class="va">ii</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">-</span><span class="va">amp</span>, <span class="va">amp</span><span class="op">)</span> <span class="op">*</span> <span class="va">baseSignal</span><span class="op">}</span></span>
<span></span>
<span><span class="va">baseSignal</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="va">time</span> <span class="op">*</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">[</span>, <span class="fl">11</span><span class="op">]</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span>, <span class="fl">11</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">baseSignal</span></span>
<span><span class="va">x</span><span class="op">[</span>, <span class="fl">12</span><span class="op">]</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span>, <span class="fl">12</span><span class="op">]</span> <span class="op">-</span> <span class="va">baseSignal</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">ii</span> <span class="kw">in</span> <span class="fl">13</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span><span class="op">[</span>, <span class="va">ii</span><span class="op">]</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span>, <span class="va">ii</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">-</span><span class="va">amp</span>, <span class="va">amp</span><span class="op">)</span> <span class="op">*</span> <span class="va">baseSignal</span><span class="op">}</span></span>
<span></span>
<span><span class="va">baseSignal</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="va">time</span> <span class="op">*</span> <span class="fl">4</span> <span class="op">*</span> <span class="va">pi</span> <span class="op">+</span> <span class="va">pi</span> <span class="op">/</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">[</span>, <span class="fl">21</span><span class="op">]</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span>, <span class="fl">21</span><span class="op">]</span> <span class="op">+</span> <span class="va">baseSignal</span></span>
<span><span class="va">x</span><span class="op">[</span>, <span class="fl">22</span><span class="op">]</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span>, <span class="fl">22</span><span class="op">]</span> <span class="op">-</span> <span class="va">baseSignal</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">ii</span> <span class="kw">in</span> <span class="fl">23</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span><span class="op">[</span>, <span class="va">ii</span><span class="op">]</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span>, <span class="va">ii</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">-</span><span class="va">amp</span>, <span class="va">amp</span><span class="op">)</span> <span class="op">*</span> <span class="va">baseSignal</span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="create-training-and-testing-observations">Create training and testing observations<a class="anchor" aria-label="anchor" href="#create-training-and-testing-observations"></a>
</h2>
<p>Now we’ll split the dataset into training and test sets.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idxTrain</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">nObs</span> <span class="op">*</span> <span class="fl">0.6</span><span class="op">)</span></span>
<span></span>
<span><span class="va">xTrain</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">idxTrain</span>, <span class="op">]</span></span>
<span><span class="va">timeTrain</span> <span class="op">=</span> <span class="va">time</span><span class="op">[</span><span class="va">idxTrain</span><span class="op">]</span></span>
<span></span>
<span><span class="va">xTest</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="va">idxTrain</span>, <span class="op">]</span></span>
<span><span class="va">timeTest</span> <span class="op">=</span> <span class="va">time</span><span class="op">[</span><span class="op">-</span><span class="va">idxTrain</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="train-and-test-a-zeitzeiger-predictor">Train and test a ZeitZeiger predictor<a class="anchor" aria-label="anchor" href="#train-and-test-a-zeitzeiger-predictor"></a>
</h2>
<p>ZeitZeiger has three main steps: <code>zeitzeigerFit</code>,
<code>zeitzeigerSpc</code>, and <code>zeitzeigerPredict</code>. Each
function has several options, please see the help and <a href="https://doi.org/10.1093/nar/gkw030" class="external-link">Hughey et al. (2016)</a> for
more details. The preferred way to use them is to call each function
separately. This lets you change the parameters for a later step without
re-running the earlier steps.</p>
<p><code>zeitzeigerFit</code> uses the training data to fit a periodic
smoothing spline to the behavior of each feature as a function of time.
<code>zeitzeigerSpc</code> then uses the spline fits to calculate sparse
principal components (SPCs) for how the features change over time.
<code>zeitzeigerPredict</code> then uses the training data and the SPCs
to predict the corresponding time for each test observation. The two
main parameters of ZeitZeiger are <code>sumabsv</code>, which controls
the amount of regularization, and <code>nSPC</code>, which controls how
many SPCs are used for prediction.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitResult</span> <span class="op">=</span> <span class="fu"><a href="../reference/zeitzeigerFit.html">zeitzeigerFit</a></span><span class="op">(</span><span class="va">xTrain</span>, <span class="va">timeTrain</span><span class="op">)</span></span>
<span><span class="va">spcResult</span> <span class="op">=</span> <span class="fu"><a href="../reference/zeitzeigerSpc.html">zeitzeigerSpc</a></span><span class="op">(</span><span class="va">fitResult</span><span class="op">$</span><span class="va">xFitMean</span>, <span class="va">fitResult</span><span class="op">$</span><span class="va">xFitResid</span>, sumabsv <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">predResult</span> <span class="op">=</span> <span class="fu"><a href="../reference/zeitzeigerPredict.html">zeitzeigerPredict</a></span><span class="op">(</span><span class="va">xTrain</span>, <span class="va">timeTrain</span>, <span class="va">xTest</span>, <span class="va">spcResult</span>, nSpc <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>Alternatively, you can run all three steps in one go using the
<code>zeitzeiger</code> function, which returns a list consisting of the
results of the above three functions.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">zzFit</span> <span class="op">=</span> <span class="fu"><a href="../reference/zeitzeiger.html">zeitzeiger</a></span><span class="op">(</span><span class="va">xTrain</span>, <span class="va">timeTrain</span>, <span class="va">xTest</span>, sumabsv <span class="op">=</span> <span class="fl">1</span>, nSpc <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="plot-the-periodic-spline-fits">Plot the periodic spline fits<a class="anchor" aria-label="anchor" href="#plot-the-periodic-spline-fits"></a>
</h2>
<p>Before looking at the predictions, it’s a good idea to check the
quality of the spline fits.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">timeRange</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span> <span class="op">-</span> <span class="fl">0.01</span>, <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">jj</span> <span class="op">=</span> <span class="fl">11</span></span>
<span></span>
<span><span class="va">df1</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span><span class="va">timeTrain</span>, xTrain <span class="op">=</span> <span class="va">xTrain</span><span class="op">[</span>, <span class="va">jj</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">df2</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>  timeRange <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">timeRange</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Observed mean'</span>, <span class="st">'Predicted mean'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">timeRange</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/predictIntensity.html">predictIntensity</a></span><span class="op">(</span><span class="va">fitResult</span><span class="op">$</span><span class="va">xFitMean</span><span class="op">[</span><span class="va">jj</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, <span class="va">timeRange</span><span class="op">)</span>,</span>
<span>            <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="va">timeRange</span> <span class="op">*</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>For feature 11, the fit looks good. In a real-world dataset, we
wouldn’t know the observed mean, so we could only compare the predicted
mean to the observations.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">timeTrain</span>, y <span class="op">=</span> <span class="va">xTrain</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">df1</span>, shape <span class="op">=</span> <span class="fl">1</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">timeRange</span>, y <span class="op">=</span> <span class="va">value</span>, linetype <span class="op">=</span> <span class="va">parameter</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">df2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Time'</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">'Feature %d'</span>, <span class="va">jj</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.85</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-9-1.png" width="384"></p>
</div>
<div class="section level2">
<h2 id="plot-prediction-error-on-the-test-set">Plot prediction error on the test set<a class="anchor" aria-label="anchor" href="#plot-prediction-error-on-the-test-set"></a>
</h2>
<p>We can calculate the difference between predicted time and observed
time, i.e., the error, using <code>getCircDiff</code>. This function
accounts for the fact that time is periodic, so <code>time = 0</code> is
equivalent to <code>time = 1</code>. The error can range from -0.5 to
0.5.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dfTest</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  timeObs <span class="op">=</span> <span class="va">timeTest</span>, timePred <span class="op">=</span> <span class="va">predResult</span><span class="op">$</span><span class="va">timePred</span>,</span>
<span>  timeError <span class="op">=</span> <span class="fu"><a href="../reference/getCircDiff.html">getCircDiff</a></span><span class="op">(</span><span class="va">predResult</span><span class="op">$</span><span class="va">timePred</span>, <span class="va">timeTest</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>There are many ways to examine prediction accuracy. A simple one is
to plot predicted time vs. observed time. Ideally, all points would lie
on the line <code>y = x</code>. These predictions are pretty good. A
couple test observations with an observed time of 0 have a predicted
time slightly less than 1, which is ok.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dfTest</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">timeObs</span>, y <span class="op">=</span> <span class="va">timePred</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span>, shape <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, intercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">'dashed'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Observed time'</span>, y <span class="op">=</span> <span class="st">'Predicted time'</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-11-1.png" width="336"></p>
<p>When we plot error vs. observed time, we see those observations have
a small negative error.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dfTest</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">timeObs</span>, y <span class="op">=</span> <span class="va">timeError</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span>, shape <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.2</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Observed time'</span>, y <span class="op">=</span> <span class="st">'Error'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-12-1.png" width="336"></p>
</div>
<div class="section level2">
<h2 id="plot-a-test-observations-time-dependent-likelihood">Plot a test observation’s time-dependent likelihood<a class="anchor" aria-label="anchor" href="#plot-a-test-observations-time-dependent-likelihood"></a>
</h2>
<p>The predicted time for a test observation is the time with maximum
likelihood. Another output of <code>zeitzeigerPredict</code>, however,
is the likelihood across the entire range of time. By default, this
likelihood is calculated at 100 discrete time-points, the same as
<code>timeRange</code> that we defined earlier (the predicted time is
not restricted to being one of these time-points).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs</span> <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="va">dfLike</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span><span class="va">timeRange</span>, likelihood <span class="op">=</span> <span class="va">predResult</span><span class="op">$</span><span class="va">timeDepLike</span><span class="op">[</span><span class="va">obs</span>, <span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dfVert</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Observed time'</span>, <span class="st">'Predicted time'</span><span class="op">)</span>,</span>
<span>  xint <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">timeTest</span><span class="op">[</span><span class="va">obs</span><span class="op">]</span>, <span class="va">predResult</span><span class="op">$</span><span class="va">timePred</span><span class="op">[</span><span class="va">obs</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>For this observation, notice how the likelihood starts increasing at
times slightly less than 1, then continues to increase at times greater
than 0.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dfLike</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">timeRange</span>, y <span class="op">=</span> <span class="va">likelihood</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span>, shape <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">xint</span>, linetype <span class="op">=</span> <span class="va">type</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dfVert</span>,</span>
<span>             show.legend <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_linetype_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'solid'</span>, <span class="st">'dashed'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Time'</span>, y <span class="op">=</span> <span class="st">'Likelihood'</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.8</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-14-1.png" width="384"></p>
</div>
<div class="section level2">
<h2 id="run-cross-validation">Run cross-validation<a class="anchor" aria-label="anchor" href="#run-cross-validation"></a>
</h2>
<p>To determine the best parameters for training a ZeitZeiger predictor,
we can run cross-validation. The cross-validation functions can process
the folds in parallel, if <code>registerDoParallel</code> is called
beforehand. Because the three steps of ZeitZeiger are separated, we need
to first randomly assign each observation to a fold, then use the same
assignments for <code>zeitzeigerFitCv</code> and
<code>zeitzeigerPredictCv</code>.</p>
<p>Here we’ll run cross-validation over three values of
<code>sumabsv</code> and four values of <code>nSPC</code>. Typically a
few values of <code>sumabsv</code> will suffice, and <code>nSPC</code>
in this example can only range from 1 to 10 (because 10 is the default
value of <code>nTime</code>).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sumabsv</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1.5</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">nSpc</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span></span>
<span><span class="va">nFolds</span> <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="va">foldid</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nFolds</span>, length.out <span class="op">=</span> <span class="va">nObs</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fitResultList</span> <span class="op">=</span> <span class="fu"><a href="../reference/zeitzeigerFitCv.html">zeitzeigerFitCv</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">time</span>, <span class="va">foldid</span><span class="op">)</span></span>
<span></span>
<span><span class="va">spcResultList</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">ii</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sumabsv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">spcResultList</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="../reference/zeitzeigerSpcCv.html">zeitzeigerSpcCv</a></span><span class="op">(</span><span class="va">fitResultList</span>, sumabsv <span class="op">=</span> <span class="va">sumabsv</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span><span class="op">)</span><span class="op">}</span></span>
<span></span>
<span><span class="va">predResultList</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">ii</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sumabsv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">predResultList</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="../reference/zeitzeigerPredictCv.html">zeitzeigerPredictCv</a></span><span class="op">(</span></span>
<span>    <span class="va">x</span>, <span class="va">time</span>, <span class="va">foldid</span>, <span class="va">spcResultList</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span>, nSpc <span class="op">=</span> <span class="va">nSpc</span><span class="op">)</span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="plot-the-error-for-each-set-of-parameter-values">Plot the error for each set of parameter values<a class="anchor" aria-label="anchor" href="#plot-the-error-for-each-set-of-parameter-values"></a>
</h2>
<p>Before plotting, we need to reorganize the output, making a
<code>data.frame</code> with the information for each prediction.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">timePredList</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">predResultList</span>, <span class="kw">function</span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="va">a</span><span class="op">$</span><span class="va">timePred</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cvResult</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">timePredList</span><span class="op">)</span>,</span>
<span>  timeObs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">time</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sumabsv</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  sumabsv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">sumabsv</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nObs</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sumabsv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cvResultMelt</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span></span>
<span>  <span class="va">cvResult</span>, id.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'obs'</span>, <span class="st">'timeObs'</span>, <span class="st">'sumabsv'</span><span class="op">)</span>, variable.name <span class="op">=</span> <span class="st">'nSpc'</span>,</span>
<span>  value.name <span class="op">=</span> <span class="st">'timePred'</span>, variable.factor <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">cvResultMelt</span><span class="op">[</span>, <span class="va">nSpc</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">nSpc</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">cvResultMelt</span><span class="op">[</span>, <span class="va">sumabsv</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sumabsv</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">cvResultMelt</span><span class="op">[</span>, <span class="va">timeError</span> <span class="op">:=</span> <span class="fu"><a href="../reference/getCircDiff.html">getCircDiff</a></span><span class="op">(</span><span class="va">timePred</span>, <span class="va">timeObs</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>Now calculate the median absolute error for each set of parameter
values.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cvResultMeltGroup</span> <span class="op">=</span></span>
<span>  <span class="va">cvResultMelt</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>medae <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">timeError</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">sumabsv</span>, <span class="va">nSpc</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>In this example dataset, the best accuracy seems to be at
<code>sumabsv = 1</code> and <code>nSpc = 3</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">cvResultMeltGroup</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">nSpc</span>, y <span class="op">=</span> <span class="va">medae</span>, shape <span class="op">=</span> <span class="va">sumabsv</span>, color <span class="op">=</span> <span class="va">sumabsv</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Number of SPCs'</span>, y <span class="op">=</span> <span class="st">'Median absolute error'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-18-1.png" width="288"></p>
</div>
<div class="section level2">
<h2 id="train-a-model-on-the-full-dataset">Train a model on the full dataset<a class="anchor" aria-label="anchor" href="#train-a-model-on-the-full-dataset"></a>
</h2>
<p>Now we can train a predictor on the full dataset using the almost
optimal <code>sumabsv</code> (to keep things interesting) from
cross-validation (all values of <code>nSpc</code> come along for free),
and look at what ZeitZeiger has learned.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitResultFinal</span> <span class="op">=</span> <span class="fu"><a href="../reference/zeitzeigerFit.html">zeitzeigerFit</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">time</span><span class="op">)</span></span>
<span><span class="va">spcResultFinal</span> <span class="op">=</span> <span class="fu"><a href="../reference/zeitzeigerSpc.html">zeitzeigerSpc</a></span><span class="op">(</span></span>
<span>  <span class="va">fitResultFinal</span><span class="op">$</span><span class="va">xFitMean</span>, <span class="va">fitResultFinal</span><span class="op">$</span><span class="va">xFitResid</span>, sumabsv <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dfVar</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>  spc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">spcResultFinal</span><span class="op">$</span><span class="va">d</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  propVar <span class="op">=</span> <span class="va">spcResultFinal</span><span class="op">$</span><span class="va">d</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">spcResultFinal</span><span class="op">$</span><span class="va">d</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Only the first three SPCs explain any appreciable amount of the
variance in how the features change over time. This makes sense, as
accuracy stopped improving or got worse at <code>nSpc = 4</code>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dfVar</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">spc</span>, y <span class="op">=</span> <span class="va">propVar</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span>, shape <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'SPC'</span>, y <span class="op">=</span> <span class="st">'Proportion of\nvariance explained'</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="plot-the-behavior-of-the-spcs-over-time">Plot the behavior of the SPCs over time<a class="anchor" aria-label="anchor" href="#plot-the-behavior-of-the-spcs-over-time"></a>
</h2>
<p>Now we can project the observations from feature-space to SPC-space,
to look at how the three SPCs behave over time.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z</span> <span class="op">=</span> <span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">spcResultFinal</span><span class="op">$</span><span class="va">v</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'SPC 1'</span>, <span class="st">'SPC 2'</span>, <span class="st">'SPC 3'</span><span class="op">)</span></span>
<span><span class="va">zMelt</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span><span class="va">z</span>, obs <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">nObs</span>, Time <span class="op">=</span> <span class="va">time</span>, check.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  id.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'obs'</span>, <span class="st">'Time'</span><span class="op">)</span>, variable.name <span class="op">=</span> <span class="st">'SPC'</span>, value.name <span class="op">=</span> <span class="st">'Abundance'</span><span class="op">)</span></span></code></pre></div>
<p>We see that each SPC corresponds to one of the three signals that we
created in the dataset. The signs are reversed, but that’s ok. So these
are the patterns that ZeitZeiger was using to predict the time.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">zMelt</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">SPC</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">'free_y'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Time</span>, y <span class="op">=</span> <span class="va">Abundance</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span>, shape <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-22-1.png" width="480"></p>
</div>
<div class="section level2">
<h2 id="plot-the-coefficients-of-the-features-for-the-spcs">Plot the coefficients of the features for the SPCs<a class="anchor" aria-label="anchor" href="#plot-the-coefficients-of-the-features-for-the-spcs"></a>
</h2>
<p>Finally, we can look at which features contribute to which SPCs.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">v</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">spcResultFinal</span><span class="op">$</span><span class="va">v</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'SPC 1'</span>, <span class="st">'SPC 2'</span>, <span class="st">'SPC 3'</span><span class="op">)</span></span>
<span><span class="va">v</span> <span class="op">=</span> <span class="va">v</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">v</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">r</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">v</span><span class="op">[</span><span class="va">v</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="va">v</span> <span class="op">=</span> <span class="va">v</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">order</span>, <span class="va">v</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">v</span><span class="op">$</span><span class="va">feature</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span><span class="va">vMelt</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, id.vars <span class="op">=</span> <span class="st">'feature'</span>, variable.name <span class="op">=</span> <span class="st">'spc'</span>,</span>
<span>             value.name <span class="op">=</span> <span class="st">'Coefficient'</span><span class="op">)</span></span>
<span><span class="va">vMelt</span><span class="op">[</span>, <span class="va">feature</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">feature</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">v</span><span class="op">$</span><span class="va">feature</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>Sure enough, ZeitZeiger found all the features with strong signal. In
addition, the sign and value of the coefficient for each feature in its
respective SPC correspond to what we simulated.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">vMelt</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">spc</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">feature</span>, y <span class="op">=</span> <span class="va">Coefficient</span><span class="op">)</span>, stat <span class="op">=</span> <span class="st">'identity'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Feature'</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.spacing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">1.2</span>, <span class="st">'lines'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 50 rows containing missing values (`position_stack()`).</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-24-1.png" width="480"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Jake Hughey.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
